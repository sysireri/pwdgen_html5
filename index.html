<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Générateur de mot de passe</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:2rem;max-width:720px}
    label{display:block;margin-top:0.75rem}
    input[type="number"]{width:5rem}
    .out{margin-top:1rem;padding:1rem;background:#f3f3f3;border-radius:6px;word-break:break-all}
    button{margin-top:0.75rem;padding:.5rem 1rem;border-radius:6px;cursor:pointer}
    .meta{margin-top:.5rem;color:#444;font-size:.95rem}
    .small{font-size:.9rem;color:#666}
  </style>
</head>
<body>
  <h1>Générateur de mot de passe fort</h1>

  <label>
    Longueur :
    <input id="length" type="number" min="1" max="128" value="16" />
  </label>

  <label><input id="upper" type="checkbox" checked /> Majuscules (A-Z)</label>
  <label><input id="lower" type="checkbox" checked /> Minuscules (a-z)</label>
  <label><input id="digits" type="checkbox" checked /> Chiffres (0-9)</label>
  <label><input id="symbols" type="checkbox" checked /> Symboles (!@#...)</label>

  <div>
    <button id="gen">Générer</button>
    <button id="copy">Copier</button>
  </div>

  <div class="out" id="result" aria-live="polite">—</div>
  <div class="meta" id="combos">Combinaisons possibles : —</div>
  <div class="meta small" id="explain">Explication : —</div>

  <script>
    const upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lower = 'abcdefghijklmnopqrstuvwxyz';
    const digits = '0123456789';
    const symbols = '!@#$%^&*()-_=+[]{};:,.<>?/~`';

    function secureRandomInt(max) {
      const array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return array[0] % max;
    }

    function generate(len, opts) {
      let pool = '';
      if (opts.upper) pool += upper;
      if (opts.lower) pool += lower;
      if (opts.digits) pool += digits;
      if (opts.symbols) pool += symbols;
      if (!pool) return '';

      const mustHave = [];
      if (opts.upper) mustHave.push(upper);
      if (opts.lower) mustHave.push(lower);
      if (opts.digits) mustHave.push(digits);
      if (opts.symbols) mustHave.push(symbols);

      if (len < mustHave.length) return '';

      const chars = [];
      for (const set of mustHave) chars.push(set[secureRandomInt(set.length)]);
      while (chars.length < len) chars.push(pool[secureRandomInt(pool.length)]);

      // mélange Fisher–Yates
      for (let i = chars.length - 1; i > 0; i--) {
        const j = secureRandomInt(i + 1);
        [chars[i], chars[j]] = [chars[j], chars[i]];
      }
      return chars.join('');
    }

    // Nombre total de combinaisons (pool^len)
    function totalCombinations(len, opts) {
      let poolSize = 0;
      if (opts.upper) poolSize += upper.length;
      if (opts.lower) poolSize += lower.length;
      if (opts.digits) poolSize += digits.length;
      if (opts.symbols) poolSize += symbols.length;
      if (poolSize === 0 || len <= 0) return 0n;
      return BigInt(poolSize) ** BigInt(len);
    }

    // Inclusion–exclusion pour "au moins un de chaque type"
    function constrainedCombinations(len, opts) {
      const sets = [];
      if (opts.upper) sets.push(upper.length);
      if (opts.lower) sets.push(lower.length);
      if (opts.digits) sets.push(digits.length);
      if (opts.symbols) sets.push(symbols.length);

      const k = sets.length;
      if (k === 0 || len < k) return 0n;

      const S = sets.reduce((a,b)=>a+b, 0);
      let total = 0n;
      const subsets = 1 << k;

      for (let mask = 0; mask < subsets; mask++) {
        let removed = 0, bits = 0;
        for (let i = 0; i < k; i++) {
          if (mask & (1 << i)) { removed += sets[i]; bits++; }
        }
        const base = S - removed;
        if (base <= 0) continue;
        const term = BigInt(base) ** BigInt(len);
        total += (bits % 2 === 0 ? term : -term);
      }
      return total;
    }

    function formatBigIntCount(n) {
      if (n === 0n) return {text:'0', sci:'0', bits:0};
      const s = n.toString();
      const d = s.length;
      const mant = Number(s.slice(0,15)) / Math.pow(10,14);
      const exp = d - 1;
      const sci = mant.toFixed(6) + ' × 10^' + exp;
      const bits = (d - 1) * Math.log2(10) + Math.log2(mant);
      return {text:s, sci, bits};
    }

    function updateCombosDisplay() {
      const len = parseInt(document.getElementById('length').value, 10) || 0;
      const opts = {
        upper: document.getElementById('upper').checked,
        lower: document.getElementById('lower').checked,
        digits: document.getElementById('digits').checked,
        symbols: document.getElementById('symbols').checked
      };

      const total = totalCombinations(len, opts);
      const constrained = constrainedCombinations(len, opts);
      const ftot = formatBigIntCount(total);
      const fcon = formatBigIntCount(constrained);

      document.getElementById('combos').textContent =
        `Total (pool^len) : ${ftot.text} — Avec contrainte : ${fcon.text}`;

      document.getElementById('explain').textContent =
        `≈ ${fcon.sci} — Entropie ≈ ${fcon.bits.toFixed(2)} bits  (sur ${ftot.bits.toFixed(2)} bits possibles)`;
    }

    function estimateStrength(pw) {
      const used = [upper, lower, digits, symbols]
        .reduce((a,s)=>a + (pw.split('').some(ch=>s.includes(ch))?s:''), '');
      const uniq = new Set(used.split('')).size;
      const entropy = Math.log2(uniq || 1) * pw.length;
      if (entropy < 50) return 'Faible';
      if (entropy < 80) return 'Moyen';
      return 'Fort';
    }

    document.getElementById('gen').addEventListener('click', () => {
      const len = parseInt(document.getElementById('length').value,10) || 8;
      const opts = {
        upper: document.getElementById('upper').checked,
        lower: document.getElementById('lower').checked,
        digits: document.getElementById('digits').checked,
        symbols: document.getElementById('symbols').checked
      };
      const pw = generate(len, opts);
      const res = document.getElementById('result');
      if (!pw) res.textContent = 'Sélectionne au moins un type de caractère.';
      else res.textContent = pw + '  —  ' + estimateStrength(pw);
      updateCombosDisplay();
    });

    document.getElementById('copy').addEventListener('click', async () => {
      const text = document.getElementById('result').textContent.split('  —  ')[0];
      if (!text || text === '—') return;
      await navigator.clipboard.writeText(text);
      alert('Mot de passe copié dans le presse-papier.');
    });

    ['length','upper','lower','digits','symbols'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCombosDisplay);
      document.getElementById(id).addEventListener('change', updateCombosDisplay);
    });

    updateCombosDisplay();
  </script>
</body>
</html>
